FROM eclipse-temurin:17-jdk AS build
WORKDIR /workspace

COPY app/gradlew app/gradlew.bat app/build.gradle app/settings.gradle /workspace/
COPY app/gradle /workspace/gradle
RUN chmod +x /workspace/gradlew

RUN ./gradlew --no-daemon dependencies || true

COPY app/src /workspace/src
COPY app/src/main/resources /workspace/src/main/resources
RUN ./gradlew --no-daemon clean bootJar

FROM eclipse-temurin:17-jre
WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends wget ca-certificates \
  && rm -rf /var/lib/apt/lists/*

RUN useradd -r -u 10001 -g root appuser

COPY --from=build /workspace/build/libs/devops-app-0.0.1.jar /app/app.jar

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=3s --start-period=20s --retries=3 \
  CMD wget -qO- http://localhost:8080/actuator/health || exit 1

USER 10001
ENTRYPOINT ["java","-jar","/app/app.jar"]
